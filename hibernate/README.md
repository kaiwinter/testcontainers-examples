## testcontainers-examples: hibernate

First the [`persistence.xml`](https://github.com/kaiwinter/testcontainers-examples/blob/master/hibernate/src/test/resources/META-INF/persistence.xml) for the tests has to be prepared:

```xml
<properties>
   <property name="jakarta.persistence.jdbc.driver" value="org.testcontainers.jdbc.ContainerDatabaseDriver" />
   <property name="jakarta.persistence.jdbc.url" value="jdbc:tc:mysql:5.7://doesntmatter/test?TC_INITSCRIPT=DDL.sql" />
   <property name="hibernate.dialect" value="org.hibernate.dialect.MySQLDialect" />
</properties>
```

The driver `org.testcontainers.jdbc.ContainerDatabaseDriver` is registered in the testcontainers dependency and will evaluate the `jdbc.url` to start the right docker image.
In this case `mysql:5.7` will start.
The persistence unit then is configured with the connection to the database in the docker container by testcontainers.
The property suffix `?TC_INITSCRIPT=DDL.sql` initializes the database with the DB model.
This is not necessary as the model can be generated by Hibernate (`hibernate.hbm2ddl.auto`) also.

Then, in the tests an `EntityManager` is created:

```java
EntityManager em = Persistence.createEntityManagerFactory("TestUnit").createEntityManager();
```

This will make Hibernate parse the [`persistence.xml`](https://github.com/kaiwinter/testcontainers-examples/blob/master/hibernate/src/test/resources/META-INF/persistence.xml) which triggers testcontainers to start the MySQL docker container.
The `EntityManager` will be pointing to the docker container and can be used as usual:

```java
class UserTest {
   private static final Logger LOGGER = LoggerFactory.getLogger(UserTest.class);
   private static EntityManager entityManager = Persistence.createEntityManagerFactory("TestPU").createEntityManager();

   @Test
   void testSaveAndLoad() {
      User user = new User();
      user.setUsername("user 1");

      entityManager.getTransaction().begin();
      entityManager.persist(user);
      LOGGER.info("User persisted with ID {}", user.getId());

      User userFromDb = entityManager.find(User.class, user.getId());
      assertEquals(user.getUsername(), userFromDb.getUsername());
      entityManager.getTransaction().rollback();
   }
}
```
This is the complete test class: [`UserTest`](https://github.com/kaiwinter/testcontainers-examples/blob/master/hibernate/src/test/java/com/github/kaiwinter/testcontainers/hibernate/db/entity/UserTest.java)

This way it's also possible to test your database layer, DAO, repository or whatever. Find an example in [`UserRepositoryTest`](https://github.com/kaiwinter/testcontainers-examples/blob/master/hibernate/src/test/java/com/github/kaiwinter/testcontainers/hibernate/db/UserRepositoryTest.java).
